<div class="session-detail-container">
  <div *ngIf="loading" class="loading">Loading game session...</div>
  
  <div *ngIf="error" class="error-message">
    {{ error }}
  </div>

  <!-- Character Selection Modal for Non-GM Users -->
  <div *ngIf="showCharacterSelection && !loading && session" class="character-selection-overlay">
    <div class="character-selection-modal">
      <h2>Join Game Session</h2>
      <p>Please select a character to join this session:</p>
      
      <div *ngIf="availableCharacters.length === 0" class="no-characters">
        <p>You don't have any characters yet. Please create a character first.</p>
      </div>
      
      <div *ngIf="availableCharacters.length > 0" class="character-selection">
        <select 
          [(ngModel)]="selectedCharacterId" 
          class="character-select"
          [disabled]="joiningSession"
          title="Select a character to join the session"
          aria-label="Select a character to join the session">
          <option [value]="null" disabled>Select a character...</option>
          <option *ngFor="let char of availableCharacters" [value]="char.id">
            {{ char.name }} 
            <span *ngIf="char.race || char.profession">
              ({{ char.race || '' }}{{ char.race && char.profession ? ', ' : '' }}{{ char.profession || '' }})
            </span>
          </option>
        </select>
        
        <div class="selection-actions">
          <button 
            (click)="joinSession()" 
            [disabled]="!selectedCharacterId || joiningSession"
            class="join-button">
            <span *ngIf="!joiningSession">Join Session</span>
            <span *ngIf="joiningSession">Joining...</span>
          </button>
        </div>
      </div>
    </div>
  </div>

  <div *ngIf="!loading && !error && session && !showCharacterSelection" class="session-layout">
    <!-- Main Content Area -->
    <div class="session-main">
      <!-- Left Sidebar - Characters by Initiative -->
      <div class="characters-sidebar">
        <h2 class="sidebar-title">{{ session.title }}</h2>
        <div class="characters-list">
          <div 
            *ngFor="let character of characters; let i = index" 
            class="character-initiative-item"
            [class.current-turn]="i === 0"
            [title]="getCharacterOwnerName(character) ? 'Owner: ' + getCharacterOwnerName(character) : ''">
            <div class="initiative-number">{{ character.initiative ?? '' }}</div>
            <img 
              [src]="getAvatarUrl(character)" 
              [alt]="character.name + ' avatar'" 
              [title]="character.name + ' avatar'" 
              class="character-initiative-avatar"
              draggable="true"
              (dragstart)="onCharacterDragStart($event, character)"
              (dragend)="onCharacterDragEnd($event)">
            <div class="character-info">
              <div class="character-name" [ngClass]="getCharacterNameClass(character)">{{ character.name }}</div>
              <div class="character-life">
                <div class="life-progress-bar">
                  <div 
                    class="life-progress-fill"
                    [ngClass]="{
                      'life-low': getLifePercentage(character) < 33,
                      'life-medium': getLifePercentage(character) >= 33 && getLifePercentage(character) < 66
                    }"
                    [style.width.%]="getLifePercentage(character)">
                  </div>
                </div>
                <span class="life-text">
                  {{ character.currentLife ?? 0 }}/{{ character.totalLife ?? 0 }}
                </span>
              </div>
            </div>
          </div>
          <div *ngIf="characters.length === 0" class="no-characters">
            No characters in this session
          </div>
        </div>
      </div>

      <!-- Middle - Battle Map -->
      <div class="battlemap-area">
        <app-battlemap [sessionId]="sessionId!" [isGameMaster]="isGameMaster()" *ngIf="sessionId"></app-battlemap>
      </div>

      <!-- Right - Chat -->
      <div class="chat-area">
        <app-chat #chatComponent [sessionId]="sessionId!" *ngIf="sessionId"></app-chat>
      </div>
    </div>

    <!-- Bottom - Dice Roll Menu -->
    <div class="dice-menu">
      <div class="dice-buttons">
        <button class="dice-btn" (click)="rollDice(20)">
          <span class="dice-icon">üé≤</span>
          <span class="dice-label">d20</span>
        </button>
        <button class="dice-btn" (click)="rollDice(6)">
          <span class="dice-icon">üé≤</span>
          <span class="dice-label">d6</span>
        </button>
        <button class="dice-btn" (click)="rollDice(100)">
          <span class="dice-icon">üé≤</span>
          <span class="dice-label">d100</span>
        </button>
        <button class="dice-btn custom" (click)="showCustomRoll = !showCustomRoll">
          <span class="dice-icon">‚öôÔ∏è</span>
          <span class="dice-label">Custom</span>
        </button>
          <div class="talent-select-wrapper"  *ngIf="myCharacter && ((myCharacter.talents && myCharacter.talents.length > 0) || (myCharacter.spells && myCharacter.spells.length > 0))"  #talentWrapper>
            <input
              type="text"
              [(ngModel)]="talentSearchTerm"
              (focus)="onTalentInputFocus()"
              (blur)="onTalentInputBlur()"
              (keydown)="onTalentInputKeyDown($event)"
              (input)="onTalentInputChange()"
              [placeholder]="getSelectedTalentName()"
              class="talent-search-input"
              #talentInput
              [disabled]="(!myCharacter.talents || myCharacter.talents.length === 0) && (!myCharacter.spells || myCharacter.spells.length === 0)"
              title="Search and select a talent or spell">
            <div *ngIf="showTalentDropdown && getFilteredTalents().length > 0" 
                 class="talent-dropdown"
                 [style.left.px]="dropdownPosition.left"
                 [style.bottom.px]="dropdownPosition.bottom"
                 [style.width.px]="dropdownPosition.width">
              <div
                *ngFor="let item of getFilteredTalents(); let i = index"
                (mousedown)="selectTalent(item.id, item.isSpell)"
                (mouseenter)="highlightedTalentIndex = i"
                class="talent-option"
                [class.highlighted]="isTalentHighlighted(i)">
                <span class="talent-name">
                  <span *ngIf="item.isSpell" class="spell-label">‚ú® </span>{{ item.name }}
                </span>
                <span class="talent-details">({{ item.check }}) - {{ item.value }}</span>
              </div>
            </div>
            <div *ngIf="showTalentDropdown && getFilteredTalents().length === 0 && talentSearchTerm.trim()" 
                 class="talent-dropdown"
                 [style.left.px]="dropdownPosition.left"
                 [style.bottom.px]="dropdownPosition.bottom"
                 [style.width.px]="dropdownPosition.width">
              <div class="talent-option no-results">No talents or spells found</div>
            </div>
          </div>
          <button 
            class="dice-btn" 
            (click)="rollTalentCheck()"
            [disabled]="!selectedTalentId">
            Roll Check
          </button>
      </div>
      <div *ngIf="showCustomRoll" class="custom-roll-panel">
        <input 
          type="number" 
          [(ngModel)]="customDiceSides" 
          placeholder="Sides"
          class="dice-input"
          min="2"
          max="1000">
        <button class="dice-btn" (click)="rollCustomDice()">Roll</button>
      </div>
      

      <!-- Weapons & combat rolls -->
      <div *ngIf="myCharacter" class="talent-roll-panel">
        <div class="talent-select-wrapper weapon-select-wrapper">
          <select
            [(ngModel)]="selectedWeaponId"
            class="talent-search-input"
            [disabled]="!myCharacter.weapons || myCharacter.weapons.length === 0"
            title="Select weapon for attack/parry rolls"
            aria-label="Select weapon for attack and parry rolls">
            <option [ngValue]="null" *ngIf="!myCharacter.weapons || myCharacter.weapons.length === 0">
              No weapons
            </option>
            <option *ngFor="let w of myCharacter.weapons" [ngValue]="w.id">
              {{ w.name }} (AT {{ w.atMod >= 0 ? '+' + w.atMod : w.atMod }}, PA {{ w.paMod >= 0 ? '+' + w.paMod : w.paMod }})
            </option>
          </select>
        </div>
        <button class="dice-btn" (click)="rollAttack()">
          Roll Attack
        </button>
        <button class="dice-btn" (click)="rollParry()">
          Roll Parry
        </button>
        <button class="dice-btn" (click)="rollDodge()">
          Roll Dodge
        </button>
        <button class="dice-btn custom" (click)="openWeaponsDialog()">
          Manage Weapons
        </button>
      </div>
      
      <!-- Character Stat Modifications -->
      <div *ngIf="myCharacter" class="character-stats-panel">
        <!-- Life Controls -->
        <div class="stat-control-group">
          <span class="stat-label">‚ù§Ô∏è Life:</span>
          <button class="stat-btn-small" (click)="quickModifyLife(-1)">-</button>
          <input 
            type="number" 
            [(ngModel)]="lifeModValue" 
            placeholder="¬±"
            class="stat-input-small"
            (keyup.enter)="modifyLife()">
          <button class="stat-btn-small" (click)="quickModifyLife(1)">+</button>
          <button class="stat-btn-apply" (click)="modifyLife()" [disabled]="lifeModValue === 0">Apply</button>
        </div>
        
        <!-- ASP Controls -->
        <div class="stat-control-group">
          <span class="stat-label">‚ú® ASP:</span>
          <button class="stat-btn-small" (click)="quickModifyAsp(-1)">-</button>
          <input 
            type="number" 
            [(ngModel)]="aspModValue" 
            placeholder="¬±"
            class="stat-input-small"
            (keyup.enter)="modifyAsp()">
          <button class="stat-btn-small" (click)="quickModifyAsp(1)">+</button>
          <button class="stat-btn-apply" (click)="modifyAsp()" [disabled]="aspModValue === 0">Apply</button>
        </div>
        
        <!-- Wounds Controls -->
        <div class="stat-control-group">
          <span class="stat-label">üíî Wounds:</span>
          <input 
            type="number" 
            [(ngModel)]="woundsValue" 
            [placeholder]="myCharacter.wounds ?? 0"
            class="stat-input-small"
            (focus)="onWoundsFocus()"
            (keyup.enter)="setWounds()"
            (blur)="setWounds()"
            title="Set wounds value">
        </div>
        
        <!-- BE Controls -->
        <div class="stat-control-group" *ngIf="myCharacter.wearingArmour">
          <span class="stat-label">üõ°Ô∏è BE:</span>
          <button class="stat-btn-small" (click)="quickModifyBe(-1)">-</button>
          <input 
            type="number" 
            [(ngModel)]="beModValue" 
            placeholder="¬±"
            class="stat-input-small"
            (keyup.enter)="modifyBe()">
          <button class="stat-btn-small" (click)="quickModifyBe(1)">+</button>
          <button class="stat-btn-apply" (click)="modifyBe()" [disabled]="beModValue === 0">Apply</button>
        </div>
        
        <button class="dice-btn stat-btn-small" (click)="performRest()">
          <span class="dice-icon">üõå</span>
          <span class="dice-label">Rest</span>
        </button>
      </div>
    </div>
  </div>

  <!-- Weapons Management Dialog (child component) -->
  <app-weapon-manager-dialog
    [visible]="showWeaponsDialog"
    [character]="myCharacter"
    [weapons]="myCharacter?.weapons || []"
    (closed)="onWeaponsDialogClosed()"
    (saved)="onWeaponsSaved($event)">
  </app-weapon-manager-dialog>
</div>

